<?xml version="1.0"?>
<openerp>
    <data>
         <!-- account.analytic.ticket -->
         <record id="view_account_analytic_ticket_search" model="ir.ui.view">
                <field name="name">account.analytic.ticket.search</field>
                <field name="model">account.analytic.ticket</field>
                <field name="arch" type="xml">
                    <search string="Ticket">
                        <field name="ref"/>
                        <field name="name"/>

                        <field name="date"/>
                        <field name="date" string="Dalla data" filter_domain="[('date','&gt;=',self)]"/>
                        <field name="date" string="Alla data" filter_domain="[('date','&lt;=',self)]"/>

                        <field name="deadline"/>
                        <field name="deadline" string="Dalla scadenza" filter_domain="[('deadline','&gt;=',self)]"/>
                        <field name="deadline" string="Alla scadenza" filter_domain="[('deadline','&lt;=',self)]"/>

                        <field name="scheduled"/>
                        <field name="scheduled" string="Dalla data schedulazione" filter_domain="[('scheduled','&gt;=',self)]"/>
                        <field name="scheduled" string="Alla data schedulazione" filter_domain="[('scheduled','&lt;=',self)]"/>

                        <field name="invoice_date"/>
                        <field name="invoice_date" string="Dalla chiusura" filter_domain="[('invoice_date','&gt;=',self)]"/>
                        <field name="invoice_date" string="Alla chiusura" filter_domain="[('invoice_date','&lt;=',self)]"/>

                        <field name="partner_id"/>
                        <field name="contact_id"/>
                        <field name="account_id" invisible="1"/>

                        <field name="user_id"/>

                        <field name="priority"/>
                        <field name="state"/>
                        <separator/>

                        <filter name="my_ticket" string="Miei ticket" domain="[('user_id','=',uid)]" />

                        <filter name="priority_low" string="Priorità Bassa" domain="[('priority','=','low')]" />
                        <filter name="priority_normal" string="Priorità Normale" domain="[('priority','=','normal')]" />
                        <filter name="priority_high" string="Priorità Alta" domain="[('priority','=','high')]" />
                        <separator/>

                        <filter name="state_draft" string="Bozza" domain="[('state','=','draft')]" />
                        <filter name="state_open" string="Aperti" domain="[('state','=','open')]" />
                        <filter name="state_suspended" string="Sospesi" domain="[('state','=','suspended')]" />
                        <filter name="state_completed" string="Completati" domain="[('state','=','completed')]" />
                        <filter name="state_close" string="Chiusi" domain="[('state','=','closed')]" />
                        <separator/>

                        <group expand="0" string="Raggruppa per...">
                            <filter string="Date" domain="[]" context="{'group_by':'date'}"/>
                            <filter string="Scadenza" domain="[]" context="{'group_by':'deadline'}"/>
                            <filter string="Schedulazione" domain="[]" context="{'group_by':'scheduled'}"/>
                            <filter string="Chiusura" domain="[]" context="{'group_by':'invoice_date'}"/>

                            <filter string="Cliente" domain="[]" context="{'group_by':'partner_id'}"/>
                            <filter string="Contatto" domain="[]" context="{'group_by':'contact_id'}" invisible="1"/>
                            <filter string="Assegnato a" domain="[]" context="{'group_by':'user_id'}"/>

                            <filter string="Commessa" domain="[]" context="{'group_by':'account_id'}"/>

                            <filter string="Priorità" domain="[]" context="{'group_by':'priority'}"/>
                            <filter string="Stato" domain="[]" context="{'group_by':'state'}"/>
                        </group>
                    </search>
                </field>
            </record>

         <record id="view_account_analytic_ticket_tree" model="ir.ui.view">
                <field name="name">account.analytic.ticket.tree</field>
                <field name="model">account.analytic.ticket</field>
                <field name='arch' type='xml'>
                    <tree string="Ticket" colors="grey:state=='suspended';blue:state=='open';green:state=='completed'" fonts="bold:state=='draft'">
                        <field name="ref" />
                        <field name="name" />
                        <field name="date" />
                        <field name="deadline" />
                        <field name="scheduled" />
                        <field name="invoice_date" />

                        <field name="partner_id" />
                        <field name="contact_id" />
                        <field name="account_id" invisible="1" />

                        <field name="max_hours" widget="float_time"/>

                        <field name="assigned_user_ids" widget="many2many_tags"/>
                        <field name="user_id" />
                        <field name="priority" />

                        <button name="assign_to_me" string="Assegna a me" type="object" icon="terp-personal" attrs="{'invisible': [('user_id', '!=', False)]}" />

                        <button name="wkf_open" string="Confermato" type="object" states="draft,suspended" icon="gtk-media-play" />
                        <button name="wkf_suspended" string="Sospendi" type="object" states="open" icon="terp-gtk-media-pause" />
                        <button name="wkf_completed" string="Completato" type="object" states="open" icon="gtk-media-stop" />  <!--STOCK_APPLY-->
                        <button name="wkf_closed" string="Chiuso" type="object" states="completed" icon="kanban-apply" />
                        <button name="wkf_restart" string="Riattiva" type="object" states="completed,closed" icon="gtk-media-previous" /> <!--gtk-revert-to-saved-->
                        <field name="state" />
                        <button name="create_new_intervention_for_ticket" string="Nuovo intervento" type="object" icon="gtk-dnd" states="open" />
                    </tree>
            </field>
        </record>

         <record id="view_account_analytic_ticket_form" model="ir.ui.view">
                <field name="name">account.analytic.ticket.form</field>
                <field name="model">account.analytic.ticket</field>
                <field name='arch' type='xml'>
                    <form string="Ticket" version="7.0">
                        <header>
                            <button name="create_new_intervention_for_ticket" string="Nuovo intervento" type="object" icon="gtk-dnd" states="open" />

                            <button name="assign_to_me" string="Assegna a me" type="object" icon="terp-personal" attrs="{'invisible': [('user_id', '!=', False)]}" />

                            <button name="wkf_open" string="Confermato" type="object" states="draft,suspended" icon="gtk-media-play" />
                            <button name="wkf_suspended" string="Sospendi" type="object" states="open" icon="terp-gtk-media-pause" />
                            <button name="wkf_completed" string="Completato" type="object" states="open" icon="gtk-media-stop" />  <!--STOCK_APPLY-->
                            <button name="wkf_closed" string="Chiuso" type="object" states="completed" icon="kanban-apply" />
                            <button name="wkf_restart" string="Riattiva" type="object" states="completed,closed" icon="gtk-media-previous" /> <!--gtk-revert-to-saved-->

                            <field name="state" widget="statusbar" readonly="1"/>
                        </header>
                        <sheet>
                           <group colspan="4" col="4">
                              <field name="ref" attrs="{'invisible': [('ref','=',False)]}"/>
                              <newline/>

                              <field name="name"  colspan="4"/>

                              <field name="partner_id" domain="[('is_company','=',True),('is_address','=',False)]" context="{'default_is_company':True}" />
                              <field name="contact_id" domain="[('is_address','=',False)]" />

                              <field name="account_id" colspan="4"
                                     context="{'with_code': True,'default_use_timesheets': 1}"
                                     domain="[('type','in',['normal','contract']),('state', '=', 'open'),('use_timesheets','=',1),'|',('partner_id','=',False),('partner_id','=',partner_id)]" />

                              <!--<field name="account_no_parent" nolabel="1" on_change="on_change_partner(partner_id,account_id,account_no_parent)"/>-->
                              <field name="assigned_user_ids" widget="many2many_tags" colspan="4"/>

                              <field name="user_id" />

                              <notebook colspan="5">
                                   <page string="Dettagli">
                                       <group colspan="4" col="4">
                                          <field name="invoice_mode" />
                                          <field name="priority" />

                                          <field name="date" />
                                          <field name="scheduled" />

                                          <field name="deadline" />
                                          <field name="max_hours" widget="float_time" />

                                          <field name="invoice_date" />

                                          <separator string="Descrizione problema [Cliente]" colspan="4" />
                                          <field name="description"  colspan="4" nolabel="1"/>
                                          <separator string="Intervento da effettuare [Responsabile]" colspan="4" />
                                          <field name="solution"  colspan="4" nolabel="1"/>
                                       </group>
                                   </page>

                                   <page string="Interventi" name="page_interventions">
                                       <group colspan="4" col="4">
                                           <separator string="Interventi abbinati" colspan="3" />
                                           <button name="create_new_intervention_for_ticket" string="Nuovo intervento" type="object" icon="gtk-dnd" states="open" colspan="1"/>

                                           <field name="intervention_ids" colspan="4" nolabel="1">
                                               <tree string="Interventi">
                                                    <field name="ref"/>
                                                    <field name="date_start"/>
                                                    <field name="intervent_duration" widget="float_time"/>
                                                    <field name="user_id"/>
                                                    <!--<field name="intervent_partner_id"/>
                                                    <field name="operation_id"/>-->
                                                    <field name="account_id" />
                                                    <field name="name"/>
                                                    <field name="mode"/>
                                                    <field name="state"/>
                                                    <!--<field name="to_invoice"/>
                                                    <field name="mode"/>

                                                    <button name="intervention_draft" string="Draft" states="cancel" icon="gtk-go-back"/>

                                                    <button name="intervention_waiting" string="Waiting" states="draft" icon="gtk-execute"/>
                                                    <button name="intervention_confirmed" string="Confirmed" states="draft" icon="gtk-go-forward"/>

                                                    <button name="intervention_waiting_cancel" string="Cancel" states="waiting" icon="gtk-cancel"/>
                                                    <button name="intervention_reschedule" string="Reschedule" states="waiting" icon="gtk-go-back"/>
                                                    <button name="intervention_waiting_confirmed" string="Confirmed" states="waiting" icon="gtk-go-forward"/>

                                                    <button name="intervention_confirmed_cancel" string="Cancel" states="confirmed" icon="gtk-cancel"/>
                                                    <button name="intervention_report_close" string="Close with report" states="confirmed" icon="gtk-go-forward"/>
                                                    <button name="intervention_close" string="Close" states="confirmed" icon="gtk-ok"/>

                                                    <button name="intervention_report_after_close" string="Report after close" states="close" icon="gtk-ok" />-->
                                               </tree>
                                           </field>
                                       </group>
                                   </page>
                              </notebook>
                           </group>
                        </sheet>
                        <div class="oe_chatter">
                             <field name="message_follower_ids" widget="mail_followers" />
                             <field name="message_ids" widget="mail_thread" placeholder="Messaggi..." />
                        </div>
                    </form>
                </field>
         </record>
         <record id="view_account_analytic_ticket_calendar" model="ir.ui.view">
                <field name="name">account.analytic.ticket.calendar</field>
                <field name="model">account.analytic.ticket</field>
                <field name="arch" type="xml">
                    <calendar color="user_id" date_start="deadline" string="Ticket" mode="week">
                        <field name="partner_id"/>
                        <field name="contact_id"/>
                        <field name="name"/>
                        <field name="state"/>
                        <field name="priority"/>
                    </calendar>
                </field>
        </record>
        <record id="action_account_analytic_ticket_tree" model="ir.actions.act_window">
            <field name="name">Ticket</field>
            <field name="res_model">account.analytic.ticket</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form,calendar</field>
            <field name="view_id" ref="view_account_analytic_ticket_tree"/>
            <field name="search_view_id" ref="view_account_analytic_ticket_search"/>
            <field name="context">{}</field>
        </record>
        <record id="action_my_account_analytic_ticket_tree" model="ir.actions.act_window">
            <field name="name">Ticket assegnati</field>
            <field name="res_model">account.analytic.ticket</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form,calendar</field>
            <field name="view_id" ref="view_account_analytic_ticket_tree"/>
            <field name="search_view_id" ref="view_account_analytic_ticket_search"/>
            <field name="context">{'search_default_my_ticket': True}</field>
        </record>
        <record id="action_unassigned_account_analytic_ticket_tree" model="ir.actions.act_window">
            <field name="name">Ticket da assegnare</field>
            <field name="res_model">account.analytic.ticket</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form,calendar</field>
            <field name="view_id" ref="view_account_analytic_ticket_tree"/>
            <field name="search_view_id" ref="view_account_analytic_ticket_search"/>
            <field name="domain">[('user_id', '=', False)]</field>
            <field name="context">{}</field>
        </record>

        <menuitem name="Ticket" parent="hr.menu_hr_root" id="menu_base_ticket" sequence="0" groups="intervention_report.group_ticket_manager,intervention_report.group_ticket_operator"/>
            <menuitem name="Ticket totali" parent="menu_base_ticket" id="menu_action_account_analytic_ticket_tree"
                      action="action_account_analytic_ticket_tree" sequence="10" groups="intervention_report.group_ticket_manager"/>

            <menuitem name="Ticket assegnati" parent="menu_base_ticket" id="menu_action_my_account_analytic_ticket_tree"
                      action="action_my_account_analytic_ticket_tree" sequence="20" />
            <menuitem name="Ticket da assegnare" parent="menu_base_ticket" id="menu_action_unassigned_account_analytic_ticket_tree"
                      action="action_unassigned_account_analytic_ticket_tree" sequence="30" />

    </data>
</openerp>
